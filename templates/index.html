<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title >Ellora AI</title>
    <link rel="icon" href="assests/elloraicon.svg" type="image/x-icon">
    <link rel="icon" href="assests/elloraicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #0f0f0f;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 0px solid #333;
            background: #0f0f0f;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
        }

        .logo i {
            margin-right: 8px;
            color: #4f46e5;
        }

        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            padding-right: 0.2cm;
        }
        
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: #1a1a1a;
        }

        .code-block {
            background: #1e293b;
            border: 1px solid #374151;
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .code-header {
            background: #0f172a;
            padding: 8px 16px;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .copy-btn {
            background: #374151;
            border: none;
            color: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .copy-btn:hover {
            background: #4b5563;
        }
        
        .copy-btn.copied {
            background: #10b981;
        }
        

        /* Sidebar */
        #sidebar {
            width: 260px;
            background: #0f0f0f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px 16px;
        }

        .sidebar.mobile-open {
            width: 260px;
            transform: translateX(0);
            transition: transform 0.3s;
        }
        .sidebar.mobile-closed {
            width: 0;
            transform: translateX(-100%);
            transition: transform 0.3s;
        }

        #current-personality {
            padding-left: 0.2cm;
            font-size: large;
        }

        .new-chat-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .new-chat-btn:hover {
            background: #4338ca;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #ccc;
            transition: background 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: #333;
        }

        .conversation-item.active {
            background: #4f46e5;
            color: white;
        }

        .conversation-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .conversation-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .edit-conversation {
            position: absolute;
            top: 50%;
            right: 40px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            
        }

        .conversation-item:hover .edit-conversation {
            opacity: 1;
        }

        .edit-conversation:hover {
            color: #4f46e5;
        }

        .delete-conversation {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .conversation-item:hover .delete-conversation {
            opacity: 1;
        }

        .delete-conversation:hover {
            color: #dc2626;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f0f0f;
            padding-left: 3cm; 
            transition: padding-left 200ms ease;
        }

        

        

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }

        .welcome-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 20px;
            color: #888;
            margin-bottom: 40px;
        }

        .example-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 800px;
        }

        .example-card {
            background: #1a1a1a;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-card:hover {
            background: #2a2a2a;
            border-color: #4f46e5;
            transform: translateY(-2px);
        }

        .example-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #fff;
        }

        .example-card p {
            color: #888;
            font-size: 14px;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: scroll;
            padding: 30px;
            display: none;
            padding: 150px;
        }

        .messages-container.active {
            display: block;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4f46e5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #10b981;
        }

        .message-content {
            background: #1a1a1a;
            padding: 16px 20px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #4f46e5;
            color: white;
        }

        /* Input Container */
        .input-container {
            padding-left: 5cm;
            padding-right: 5cm;
            background: #0f0f0f;
            padding-bottom: 1cm;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2a2a2a;
            border-radius: 25px;
            padding: 12px 16px;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .input-wrapper:focus-within {
            border-color: #4f46e5;
        }

        .personality-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.3s;
        }

        .personality-btn:hover {
            color: #4f46e5;
        }

        #messageInput {
            flex: 1;
            min-height: 35px;
            background: none;
            border: darkgray;
            color: white;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            outline: darkgray;
        }

        #messageInput::placeholder {
            color: #666;
        }

    

        .input-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            color: #4f46e5;
            background: #333;
        }

        .send-btn {
            background: #4f46e5;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.3s;
        }

        .send-btn:hover {
            background: #4338ca;
        }

        .send-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Personality Selector */
        .personality-selector {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            display: none;
            z-index: 1000;
            min-width: 200px;
        }

        .personality-selector.active {
            display: block;
        }

        .personality-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.3s;
            margin-bottom: 4px;
        }

        .personality-option:hover {
            background: #333;
        }

        .personality-option.active {
            background: #4f46e5;
            color: white;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: #333;
        }

        .context-menu-item i {
            width: 16px;
            text-align: center;
        }

        /* Share Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 32px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            margin-left: auto;
        }

        .share-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .share-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #333;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .share-option:hover {
            background: #404040;
        }

        .share-option i {
            width: 24px;
            text-align: center;
            color: #4f46e5;
        }

        /* Loading Animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 16px 20px;
            background: #1a1a1a;
            border-radius: 18px;
            margin-bottom: 20px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.mobile-open {
                width: 260px;
                transform: translateX(0);
            }

            .welcome-title {
                font-size: 36px;
            }

            .example-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <!-- Logo -->
            <div class="flex items-center mb-8">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-green-500 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <h1 class="text-xl font-bold gradient-text">Ellora AI</h1>
            </div>

        <div class="header-right">
            <div class="user-info">
                <i class="fas fa-user"></i>
                <span id="userEmail">{{ user_email }}</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar open button -->
        <button id="openSidebarBtn" class="fixed top-12 left-4 z-80 bg-black-600 text-white rounded-full p-3 shadow-lg "                 style="display:none;" title="Open sidebar">
        <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-12 w-72 h-full sidebar transform -translate-x-full transition-transform duration-300 z-50">

            <!-- Sidebar close button -->
            <button id="closeSidebarBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white " title="Hide sidebar">
            <i class="fas fa-times text-2xl"></i>
            </button>
            
            
            <!-- Personality Selection -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Personality</h3>
                <div class="personality-badge text-sm px-3 py-2 rounded-lg mb-3 " id="current-personality">
                    😊 Friendly
                </div>
                <button id="change-personality" class="text-sm text-blue-400 hover:text-blue-300 transition-colors"  onclick="togglePersonalitySelector()">
                    Change personality from a face button on left of inputbar
                </button>
            </div>

            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i> New Chat
            </button>
            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatarea">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <h1 class="welcome-title">Hello, I'm Ellora</h1>
                <p class="welcome-subtitle">Ask me anything, and I'll help you learn, understand, and discover</p>
                <div class="example-cards">
                    <div class="example-card" onclick="sendExampleMessage('Tell me about artificial intelligence')">
                        <h3>Learn about AI</h3>
                        <p>Discover the world of artificial intelligence and machine learning</p>
                    </div>
                    <div class="example-card" onclick="sendExampleMessage('Help me write Python code')">
                        <h3>Get code help</h3>
                        <p>Get assistance with programming and coding challenges</p>
                    </div>
                    <div class="example-card" onclick="sendExampleMessage('Explain quantum physics')">
                        <h3>Explore physics</h3>
                        <p>Learn about complex physics concepts made simple</p>
                    </div>
                    <div class="example-card" onclick="sendExampleMessage('Help me improve my writing')">
                        <h3>Improve writing</h3>
                        <p>Get tips and feedback on your writing style</p>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be added here -->
            </div>

            <!-- Input Container -->
            <div class="input-container">
                <!-- Personality Selector -->
                <div class="personality-selector" id="personalitySelector">
                    <div class="personality-option active" data-personality="Friendly 😊">😊 Friendly</div>
                    <div class="personality-option" data-personality="Sarcastic 🥱">🥱 Sarcastic</div>
                    <div class="personality-option" data-personality="Professional 🧑">🧑 Professional</div>
                    <div class="personality-option" data-personality="Love Poet 🥰">🥰 Love Poet</div>
                    <div class="personality-option" data-personality="Vedic Vyasa 🕉️">🕉️ Vedic Vyasa</div>
                    <div class="personality-option" data-personality="Medic Expert ⚕️">⚕️ Medic Expert</div>
                </div>

                <div id="renameDlg" class="rename-overlay" style="display:none;">
                <div class="rename-box">
                    <input type="text" id="renameInput" placeholder="Enter new conversation name" />
                    <button onclick="applyRename()">Rename</button>
                    <button onclick="hideRename()">Cancel</button>
                </div>
                </div>


                <div class="input-wrapper">
                    <button class="personality-btn" onclick="togglePersonalitySelector()" title="Change Personality">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <textarea id="messageInput" placeholder="Message Ellora AI..." style="flex:1;min-height:35px;" onkeypress="handleEnter(event)" ></textarea>
                    <div class="input-actions">
                        <button class="action-btn" onclick="openFileUpload()" title="Upload File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="action-btn" onclick="toggleVoiceInput()" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="action-btn" onclick="showMoreOptions(event)" title="More Options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="clearChat()">
            <i class="fas fa-trash"></i>
            Clear Chat
        </div>
        <div class="context-menu-item" onclick="exportChat()">
            <i class="fas fa-download"></i>
            Export Chat
        </div>
        <div class="context-menu-item" onclick="showShareModal()">
            <i class="fas fa-share"></i>
            Share Chat
        </div>
        <div class="context-menu-item" onclick="showSettings()">
            <i class="fas fa-cog"></i>
            Settings
        </div>
        <div class="context-menu-item" onclick="showHelp()">
            <i class="fas fa-question-circle"></i>
            Help
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Share Conversation</h3>
                <button class="close-modal" onclick="closeShareModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="share-options">
                <div class="share-option" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i>
                    <div>
                        <div>Copy Link</div>
                        <small style="color: #888;">Share a link to this conversation</small>
                    </div>
                </div>
                <div class="share-option" onclick="shareToEmail()">
                    <i class="fas fa-envelope"></i>
                    <div>
                        <div>Share via Email</div>
                        <small style="color: #888;">Send this conversation via email</small>
                    </div>
                </div>
                <div class="share-option" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i>
                    <div>
                        <div>Export as PDF</div>
                        <small style="color: #888;">Download conversation as PDF</small>
                    </div>
                </div>
                <div class="share-option" onclick="shareToSocialMedia()">
                    <i class="fas fa-share-alt"></i>
                    <div>
                        <div>Share to Social Media</div>
                        <small style="color: #888;">Post on your social platforms</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" style="display: none;" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" onchange="handleFileUpload(event)">

    <script>
        let currentConversationId = null;
        let currentPersonality = "Friendly 😊";
        let isRecording = false;
        let conversations = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadConversations();
            
            // Click outside to close menus
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.personality-selector') && !e.target.closest('.personality-btn')) {
                    document.getElementById('personalitySelector').classList.remove('active');
                }
                if (!e.target.closest('.context-menu') && !e.target.closest('[onclick*="showMoreOptions"]')) {
                    document.getElementById('contextMenu').style.display = 'none';
                }
            });
        });

        const showpersonality = document.getElementById('current-personality');
        showpersonality.textContent = currentPersonality;
        const personalitySelector = document.getElementById('personalitySelector');
        personalitySelector.addEventListener('click', function(e) {
            if (e.target.classList.contains('personality-option')) {
                currentPersonality = e.target.getAttribute('data-personality');
                showpersonality.textContent = currentPersonality;
                personalitySelector.classList.remove('active');
            }
        });

        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        });

        // Authentication
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Conversation Management
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                const data = await response.json();
                
                if (response.ok) {
                    conversations = data;
                    renderConversations();
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // function renderConversations() {
        //     const conversationsList = document.getElementById('conversationsList');
        //     conversationsList.innerHTML = '';
            
        //     Object.entries(conversations).forEach(([id, conv]) => {
        //         const item = document.createElement('div');
        //         item.className = 'conversation-item';
        //         item.onclick = () => loadConversation(id);
                
        //         const title = conv.title || 'New Conversation';
        //         const time = new Date(conv.created_at).toLocaleDateString();
                
        //         item.innerHTML = `
        //             <div class="conversation-title">${title}</div>
        //             <div class="conversation-time">${time}</div>
        //             <button class="delete-conversation" onclick="event.stopPropagation(); deleteConversation('${id}')">
        //                 <i class="fas fa-trash"></i>
        //             </button>
        //         `;
                
        //         conversationsList.appendChild(item);
        //     });
        // }

        //changes made
        function renderConversations() {
            const list = document.getElementById('conversationsList');
            list.innerHTML = '';
            Object.entries(conversations).forEach(([id, conv]) => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.innerHTML = `
                <div class="conversation-title">${conv.title || 'New Conversation'}</div>
                <div>
                    <button class="edit-conversation" title="Rename" onclick="event.stopPropagation(); showRename('${id}' , event)">✏️</button>
                    <button class="delete-conversation" title="Delete" onclick="event.stopPropagation(); deleteConversation('${id}')">🗑️</button>
                </div>
                `;
                item.onclick = () => loadConversation(id, item);
                list.appendChild(item);
            });
        }


        async function startNewChat() {
            try {
                const response = await fetch('/api/new-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentConversationId = data.conversation_id;
                    document.getElementById('welcomeScreen').style.display = 'flex';
                    document.getElementById('messagesContainer').classList.remove('active');
                    clearActiveConversation();
                }
            } catch (error) {
                console.error('Error creating new chat:', error);
            }
        }

        async function loadConversation(conversationId) {
            currentConversationId = conversationId;
            
            // Update UI
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('messagesContainer').classList.add('active');
            
            // Mark as active
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.conversation-item').classList.add('active');
            
            // Load messages
            if (conversations[conversationId] && conversations[conversationId].messages) {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                Object.values(conversations[conversationId].messages).forEach(msg => {
                    addMessageToChat('user', msg.user_message);
                    addMessageToChat('assistant', msg.ai_response, conversations[conversationId].role);
                });
            }
        }

        // async function deleteConversation(conversationId) {
        //     if (!confirm('Are you sure you want to delete this conversation?')) return;
            
        //     try {
        //         const response = await fetch('/api/delete-conversation', {
        //             method: 'POST',
        //             headers: {
        //                 'Content-Type': 'application/json',
        //             },
        //             body: JSON.stringify({ conversation_id: conversationId })
        //         });
                
        //         if (response.ok) {
        //             delete conversations[conversationId];
        //             renderConversations();
                    
        //             if (currentConversationId === conversationId) {
        //                 startNewChat();
        //             }
        //         }
        //     } catch (error) {
        //         console.error('Error deleting conversation:', error);
        //     }
        // }

        //changes made
        let renamingConvId = null;

        function showRename(id, event) {
        event.stopPropagation();  // prevent loading conversation
        renamingConvId = id;
        const renameDlg = document.getElementById('renameDlg');
        renameDlg.style.display = 'flex';
        const renameInput = document.getElementById('renameInput');
        renameInput.value = ''; // or you can prefill current conversation title
        renameInput.focus();
        }

        function hideRename() {
        document.getElementById('renameDlg').style.display = 'none';
        }

        function applyRename() {
        const title = document.getElementById('renameInput').value.trim();
        if (!title) {
            alert('Conversation name cannot be empty');
            return;
        }
        fetch('/api/rename-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversation_id: renamingConvId, title: title }),
        })
            .then(response => response.json())
            .then(data => {
            if(data.success){
                hideRename();
                loadConversations(); // refresh sidebar titles
            } else {
                alert('Failed to rename conversation');
            }
            })
            .catch(() => alert('Network error'));
        }


        function deleteConversation(id) {
            if (!confirm('Delete this conversation?')) return;
            fetch('/api/delete-conversation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({conversation_id: id}),
            }).then(() => {
                loadConversations();
            });
        }


        function clearActiveConversation() {
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
        }

        // Personality Management
        function togglePersonalitySelector() {
            const selector = document.getElementById('personalitySelector');
            selector.classList.toggle('active');
        }

        
        function selectPersonality(personality) {
            currentPersonality = personality;
            document.querySelectorAll('.personality-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.personality === personality) {
                    option.classList.add('active');
                }
            });
            document.getElementById('personalitySelector').classList.remove('active');
        }
        


        // Add event listeners for personality options
        document.querySelectorAll('.personality-option').forEach(option => {
            option.addEventListener('click', function() {
                selectPersonality(this.dataset.personality);
            });
        });

        // Message Handling
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input and show user message
            input.value = '';
            addMessageToChat('user', message);
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        role: currentPersonality,
                        conversation_id: currentConversationId
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (response.ok) {
                    currentConversationId = data.conversation_id;
                    addMessageToChat('assistant', data.response, currentPersonality);
                    
                    // Hide welcome screen and show messages
                    document.getElementById('welcomeScreen').style.display = 'none';
                    document.getElementById('messagesContainer').classList.add('active');
                    
                    // Reload conversations to update sidebar
                    loadConversations();
                } else {
                    addMessageToChat('assistant', 'Sorry, there was an error processing your message.', currentPersonality);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessageToChat('assistant', 'Sorry, there was a network error. Please try again.', currentPersonality);
                console.error('Error sending message:', error);
            }
        }

        //changes made
        function renderMsg(role, content, emoji) {
            let el = document.createElement('div');
            el.className = 'msg-row ' + role;

            let av = document.createElement('div');
            av.className = 'msg-avatar';
            av.textContent = role === 'user' ? '🧑' : (emoji || '🤖');

            let mc = document.createElement('div');
            mc.className = 'msg-content';

            // Use marked with highlight option to parse markdown + highlight code blocks
            mc.innerHTML = marked.parse(content || "", {
                highlight: function(code, lang) {
                // Use highlight.js to highlight code segments properly
                return hljs.highlightAuto(code).value;
                }
            });

            el.append(av, mc);
            document.getElementById('messages').appendChild(el);

            // Scroll messages container to bottom
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }



        function sendExampleMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function addMessageToChat(role, content, personality = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatarIcon = role === 'user' ? '👤' : (personality ? personality.split(' ')[1] : '🤖');
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-content">${formatMessage(content)}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Basic markdown formatting
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            content = content.replace(/``````/g, '<pre><code>$1</code></pre>');
            content = content.replace(/`(.*?)`/g, '<code>$1</code>');
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">🤖</div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // File Handling
        function openFileUpload() {
            document.getElementById('fileInput').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Handle file upload logic here
            console.log('File selected:', file.name);
            // You can implement file upload to your backend
        }

        // Voice Input
        function toggleVoiceInput() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            // Implement voice recording logic
            isRecording = true;
            const btn = event.target.closest('.action-btn');
            btn.style.color = '#dc2626';
            console.log('Recording started...');
        }

        function stopRecording() {
            // Implement stop recording logic
            isRecording = false;
            const btn = document.querySelector('[onclick="toggleVoiceInput()"]');
            btn.style.color = '#888';
            console.log('Recording stopped...');
        }

        // More Options Menu
        function showMoreOptions(event) {
            const menu = document.getElementById('contextMenu');
            const rect = event.target.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.top = (rect.top - menu.offsetHeight - 10) + 'px';
            menu.style.left = rect.left + 'px';
        }

        function clearChat() {
            if (confirm('Are you sure you want to clear this chat?')) {
                document.getElementById('messagesContainer').innerHTML = '';
                document.getElementById('contextMenu').style.display = 'none';
            }
        }

        function exportChat() {
            // Implement export functionality
            console.log('Exporting chat...');
            document.getElementById('contextMenu').style.display = 'none';
        }

        function showSettings() {
            // Implement settings modal
            console.log('Showing settings...');
            document.getElementById('contextMenu').style.display = 'none';
        }

        function showHelp() {
            // Implement help modal
            console.log('Showing help...');
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Share Modal
        function showShareModal() {
            document.getElementById('shareModal').classList.add('active');
            document.getElementById('contextMenu').style.display = 'none';
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function copyToClipboard() {
            // Implement copy link functionality
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link copied to clipboard!');
                closeShareModal();
            });
        }

        function shareToEmail() {
            // Implement email sharing
            const subject = encodeURIComponent('Check out this Ellora AI conversation');
            const body = encodeURIComponent('I had an interesting conversation with Ellora AI: ' + window.location.href);
            window.open(`mailto:?subject=${subject}&body=${body}`);
            closeShareModal();
        }

        function exportPDF() {
            // Implement PDF export
            console.log('Exporting as PDF...');
            closeShareModal();
        }

        function shareToSocialMedia() {
            // Implement social media sharing
            const text = encodeURIComponent('Check out my conversation with Ellora AI');
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
            closeShareModal();
        }

        // Click outside modal to close
        document.getElementById('shareModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });


        //sdiebar functionality
            const sidebar   = document.getElementById('sidebar');
            const closeBtn  = document.getElementById('closeSidebarBtn');
            const openBtn   = document.getElementById('openSidebarBtn');

            // Helper: Hide sidebar (mobile)
            function hideSidebar() {
                sidebar.classList.add('-translate-x-full');
                openBtn.style.display = 'block';
                
            }
                // Helper: Show sidebar (mobile)
                function showSidebar() {
                    sidebar.classList.remove('-translate-x-full');
                    openBtn.style.display = 'none';

                    const chatarea = document.getElementById('chatarea');
                    chatarea?.classList.add('chat-area');
                }

                closeBtn?.addEventListener('click', hideSidebar);
                openBtn?.addEventListener('click', showSidebar);

                // Optional: Hide sidebar by default on mobile when page loads
                if (window.innerWidth <= 1024) {
                    hideSidebar();
                }

                if (window.innerWidth > 1024) {
                    showSidebar();
                } else {
                    hideSidebar();
                }


                // Optional: Hide sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    // Only on mobile, and only if sidebar is open and click is outside
                    if(window.innerWidth <= 1024 && !sidebar.classList.contains('-translate-x-full')) {
                        if (!sidebar.contains(e.target) && !openBtn.contains(e.target)) {
                            hideSidebar();
                        }
                    }
                });

            // Optional: Auto-hide/sidebar on resize
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 1024) {
                        showSidebar();
                    } else {
                        hideSidebar();
                    }
                });
    </script>
</body>
</html>

